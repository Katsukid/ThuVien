.\" Automatically generated by Pod::Man 4.10 (Pod::Simple 3.35)
.\"
.\" Standard preamble:
.\" ========================================================================
.de Sp \" Vertical space (when we can't use .PP)
.if t .sp .5v
.if n .sp
..
.de Vb \" Begin verbatim text
.ft CW
.nf
.ne \\$1
..
.de Ve \" End verbatim text
.ft R
.fi
..
.\" Set up some character translations and predefined strings.  \*(-- will
.\" give an unbreakable dash, \*(PI will give pi, \*(L" will give a left
.\" double quote, and \*(R" will give a right double quote.  \*(C+ will
.\" give a nicer C++.  Capital omega is used to do unbreakable dashes and
.\" therefore won't be available.  \*(C` and \*(C' expand to `' in nroff,
.\" nothing in troff, for use with C<>.
.tr \(*W-
.ds C+ C\v'-.1v'\h'-1p'\s-2+\h'-1p'+\s0\v'.1v'\h'-1p'
.ie n \{\
.    ds -- \(*W-
.    ds PI pi
.    if (\n(.H=4u)&(1m=24u) .ds -- \(*W\h'-12u'\(*W\h'-12u'-\" diablo 10 pitch
.    if (\n(.H=4u)&(1m=20u) .ds -- \(*W\h'-12u'\(*W\h'-8u'-\"  diablo 12 pitch
.    ds L" ""
.    ds R" ""
.    ds C` ""
.    ds C' ""
'br\}
.el\{\
.    ds -- \|\(em\|
.    ds PI \(*p
.    ds L" ``
.    ds R" ''
.    ds C`
.    ds C'
'br\}
.\"
.\" Escape single quotes in literal strings from groff's Unicode transform.
.ie \n(.g .ds Aq \(aq
.el       .ds Aq '
.\"
.\" If the F register is >0, we'll generate index entries on stderr for
.\" titles (.TH), headers (.SH), subsections (.SS), items (.Ip), and index
.\" entries marked with X<> in POD.  Of course, you'll have to process the
.\" output yourself in some meaningful fashion.
.\"
.\" Avoid warning from groff about undefined register 'F'.
.de IX
..
.nr rF 0
.if \n(.g .if rF .nr rF 1
.if (\n(rF:(\n(.g==0)) \{\
.    if \nF \{\
.        de IX
.        tm Index:\\$1\t\\n%\t"\\$2"
..
.        if !\nF==2 \{\
.            nr % 0
.            nr F 2
.        \}
.    \}
.\}
.rr rF
.\" ========================================================================
.\"
.IX Title "C4::Auth_with_shibboleth 3pm"
.TH C4::Auth_with_shibboleth 3pm "2023-10-03" "perl v5.28.1" "User Contributed Perl Documentation"
.\" For nroff, turn off justification.  Always turn off hyphenation; it makes
.\" way too many mistakes in technical documents.
.if n .ad l
.nh
.SH "NAME"
C4::Auth_with_shibboleth
.SH "SYNOPSIS"
.IX Header "SYNOPSIS"
use C4::Auth_with_shibboleth;
.SH "DESCRIPTION"
.IX Header "DESCRIPTION"
This module is specific to Shibboleth authentication in koha and relies heavily upon the native shibboleth service provider package in your operating system.
.SH "CONFIGURATION"
.IX Header "CONFIGURATION"
To use this type of authentication these additional packages are required:
.IP "\(bu" 4
libapache2\-mod\-shib2
.IP "\(bu" 4
libshibsp5:amd64
.IP "\(bu" 4
shibboleth\-sp2\-schemas
.PP
We let the native shibboleth service provider packages handle all the complexities of shibboleth negotiation for us, and configuring this is beyond the scope of this documentation.
.PP
But to sum up, to get shibboleth working in koha, as a minimum you will need to:
.IP "1." 4
Create some metadata for your koha instance (if you're in a single instance setup then the default metadata available at https://youraddress.com/Shibboleth.sso/Metadata should be adequate)
.IP "2." 4
Swap metadata with your Identidy Provider (IdP)
.IP "3." 4
Map their attributes to what you want to see in koha
.IP "4." 4
Tell apache that we wish to allow koha to authenticate via shibboleth.
.Sp
This is as simple as adding the below to your virtualhost config (for \s-1CGI\s0 running):
.Sp
.Vb 4
\& <Location />
\&   AuthType shibboleth
\&   Require shibboleth
\& </Location>
.Ve
.Sp
Or (for Plack running):
.Sp
.Vb 6
\& <Location />
\&   AuthType shibboleth
\&   Require shibboleth
\&   ShibUseEnvironment Off
\&   ShibUseHeaders On
\& </Location>
.Ve
.Sp
\&\s-1IMPORTANT:\s0 Please note, if you are running in the plack configuration you should consult https://wiki.shibboleth.net/confluence/display/SHIB2/NativeSPSpoofChecking for security advice regarding header spoof checking settings. (See also bug 17776 on Bugzilla about enabling ShibUseHeaders.)
.IP "5." 4
Configure koha to listen for shibboleth environment variables.
.Sp
This is as simple as enabling \fBuseshibboleth\fR in koha\-conf.xml:
.Sp
.Vb 1
\& <useshibboleth>1</useshibboleth>
.Ve
.IP "6." 4
Map shibboleth attributes to koha fields, and configure authentication match point in koha\-conf.xml.
.Sp
.Vb 6
\& <shibboleth>
\&   <matchpoint>userid</matchpoint> <!\-\- koha borrower field to match upon \-\->
\&   <mapping>
\&     <userid is="eduPersonID"></userid> <!\-\- koha borrower field to shibboleth attribute mapping \-\->
\&   </mapping>
\& </shibboleth>
.Ve
.Sp
Note: The minimum you need here is a <matchpoint> block, containing a valid column name from the koha borrowers table, and a <mapping> block containing a relation between the chosen matchpoint and the shibboleth attribute name.
.PP
It should be as simple as that; you should now be able to login via shibboleth in the opac.
.PP
If you need more help configuring your \fBS\fRervice \fBP\fRrovider to authenticate against a chosen \fBId\fRentity \fBP\fRrovider then it might be worth taking a look at the community wiki page <http://wiki.koha-community.org/wiki/Shibboleth_Configuration>
.SH "FUNCTIONS"
.IX Header "FUNCTIONS"
.SS "logout_shib"
.IX Subsection "logout_shib"
Sends a logout signal to the native shibboleth service provider and then logs out of koha.  Depending upon the native service provider configuration and identity provider capabilities this may or may not perform a single sign out action.
.PP
.Vb 1
\&  logout_shib($query);
.Ve
.SS "login_shib_url"
.IX Subsection "login_shib_url"
Given a query, this will return a shibboleth login url with return code to page with given given query.
.PP
.Vb 1
\&  my $shibLoginURL = login_shib_url($query);
.Ve
.SS "get_login_shib"
.IX Subsection "get_login_shib"
Returns the shibboleth login attribute should it be found present in the http session
.PP
.Vb 1
\&  my $shib_login = get_login_shib();
.Ve
.SS "checkpw_shib"
.IX Subsection "checkpw_shib"
Given a shib_login attribute, this routine checks for a matching local user and if found returns true, their cardnumber and their userid.  If a match is not found, then this returns false.
.PP
.Vb 1
\&  my ( $retval, $retcard, $retuserid ) = C4::Auth_with_shibboleth::checkpw_shib( $shib_login );
.Ve
.SS "_get_uri"
.IX Subsection "_get_uri"
.Vb 1
\&  _get_uri();
.Ve
.PP
A sugar function to that simply returns the current page \s-1URI\s0 with appropriate protocol attached
.PP
This routine is \s-1NOT\s0 exported
.SS "_get_shib_config"
.IX Subsection "_get_shib_config"
.Vb 1
\&  my $config = _get_shib_config();
.Ve
.PP
A sugar function that checks for a valid shibboleth configuration, and if found returns a hashref of it's contents
.PP
This routine is \s-1NOT\s0 exported
.SS "_autocreate"
.IX Subsection "_autocreate"
.Vb 1
\&  my ( $retval, $retcard, $retuserid ) = _autocreate( $config, $match );
.Ve
.PP
Given a shibboleth attribute reference and a userid this internal routine will add the given user to Koha and return their user credentials.
.PP
This routine is \s-1NOT\s0 exported
.SH "SEE ALSO"
.IX Header "SEE ALSO"
